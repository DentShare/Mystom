<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MiniStom — Админка</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 12px;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
    }
    h1 { font-size: 1.25rem; margin: 0 0 12px 0; }

    /* Stats cards */
    .stats { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
    .stat-card {
      flex: 1; min-width: 90px;
      background: var(--tg-theme-secondary-bg-color, #f5f5f5);
      border-radius: 10px; padding: 10px; text-align: center;
    }
    .stat-card .num { font-size: 1.5rem; font-weight: 700; }
    .stat-card .label { font-size: 11px; color: var(--tg-theme-hint-color, #888); }

    /* Toolbar */
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; align-items: center; }
    .toolbar input[type=search] {
      flex: 1; min-width: 140px; padding: 7px 10px; font-size: 14px;
      border: 1px solid var(--tg-theme-hint-color, #ccc); border-radius: 8px;
      background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000);
    }
    .toolbar select {
      padding: 7px; font-size: 13px; border-radius: 8px;
      border: 1px solid var(--tg-theme-hint-color, #ccc);
      background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000);
    }

    /* Table */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border: 1px solid var(--tg-theme-hint-color, #999); padding: 6px 8px; text-align: left; }
    th { background: var(--tg-theme-secondary-bg-color, #eee); position: sticky; top: 0; }
    select.tier, input[type=date] { padding: 4px; font-size: 12px; min-width: 90px; }
    .role { font-size: 11px; color: var(--tg-theme-hint-color, #888); }

    /* Buttons */
    button {
      padding: 6px 12px; font-size: 13px; cursor: pointer;
      background: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #fff);
      border: none; border-radius: 6px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button.secondary { background: var(--tg-theme-secondary-bg-color, #e0e0e0); color: var(--tg-theme-text-color, #333); }

    /* Pagination */
    .pagination { display: flex; gap: 8px; align-items: center; justify-content: center; margin-top: 10px; font-size: 13px; }

    /* Messages */
    .msg { padding: 8px; margin: 8px 0; border-radius: 6px; }
    .msg.error { background: #fdd; color: #c00; }
    .msg.ok { background: #dfd; color: #060; }
    .loading { color: var(--tg-theme-hint-color); }
    .id { font-size: 11px; color: var(--tg-theme-hint-color); }
  </style>
</head>
<body>
  <h1>MiniStom — Админка</h1>
  <div id="debug" class="msg" style="font-size:12px;background:var(--tg-theme-secondary-bg-color,#eee);display:none;"></div>
  <div id="stats"></div>
  <div id="msg"></div>
  <div class="toolbar">
    <input type="search" id="searchInput" placeholder="Поиск по имени, телефону, ID…">
    <select id="tierFilter">
      <option value="">Все тарифы</option>
      <option value="0">Basic</option>
      <option value="1">Standard</option>
      <option value="2">Premium</option>
    </select>
    <button type="button" id="btnRefresh">Обновить</button>
  </div>
  <div id="content"><p class="loading">Загрузка…</p></div>
  <div id="paginationBar" class="pagination"></div>

  <script>
    const Telegram = window.Telegram?.WebApp;
    if (Telegram) { Telegram.ready(); Telegram.expand(); }

    const API_BASE = window.location.origin;
    const DEBUG = true;
    const PAGE_SIZE = 50;
    let currentOffset = 0;
    let totalUsers = 0;
    let searchTimer = null;

    function getInitData() { return Telegram?.initData || ''; }

    function updateDebugInfo() {
      if (!DEBUG) return;
      const init = getInitData();
      const len = init ? init.length : 0;
      const ok = len >= 10;
      const el = document.getElementById('debug');
      if (el) {
        el.textContent = 'initData: len=' + len + (ok ? ' OK' : ' — ПУСТО. Откройте из бота!');
        el.style.display = 'block';
        el.className = 'msg ' + (ok ? 'ok' : 'error');
      }
    }

    function hdrs() {
      return { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': getInitData() };
    }

    function showMsg(text, isError) {
      const el = document.getElementById('msg');
      el.textContent = text;
      el.className = 'msg ' + (isError ? 'error' : 'ok');
      el.style.display = text ? 'block' : 'none';
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
    }

    const TIER_NAMES = { 0: 'Basic', 1: 'Standard', 2: 'Premium' };

    /* ── Stats ── */
    async function loadStats() {
      try {
        const r = await fetch(API_BASE + '/api/stats', { headers: hdrs() });
        if (!r.ok) return;
        const s = await r.json();
        document.getElementById('stats').innerHTML =
          '<div class="stats">' +
          '<div class="stat-card"><div class="num">' + s.total_users + '</div><div class="label">Пользователей</div></div>' +
          '<div class="stat-card"><div class="num">' + s.tier_counts.basic + '</div><div class="label">Basic</div></div>' +
          '<div class="stat-card"><div class="num">' + s.tier_counts.standard + '</div><div class="label">Standard</div></div>' +
          '<div class="stat-card"><div class="num">' + s.tier_counts.premium + '</div><div class="label">Premium</div></div>' +
          '<div class="stat-card"><div class="num">' + s.total_patients + '</div><div class="label">Пациентов</div></div>' +
          '<div class="stat-card"><div class="num">' + s.total_appointments + '</div><div class="label">Записей</div></div>' +
          '</div>';
      } catch (_) {}
    }

    /* ── Users ── */
    async function loadUsers() {
      updateDebugInfo();
      const content = document.getElementById('content');
      content.innerHTML = '<p class="loading">Загрузка…</p>';
      const initData = getInitData();
      if (!initData || initData.length < 10) {
        content.innerHTML = '<p class="msg error">Откройте админку из Telegram: /admin → кнопка «Админка (Web App)».</p>';
        return;
      }

      const q = document.getElementById('searchInput').value.trim();
      const tier = document.getElementById('tierFilter').value;
      let url = API_BASE + '/api/users?offset=' + currentOffset + '&limit=' + PAGE_SIZE;
      if (q) url += '&q=' + encodeURIComponent(q);
      if (tier !== '') url += '&tier=' + tier;

      try {
        const r = await fetch(url, { headers: hdrs() });
        if (r.status === 401) {
          // Вызываем debug endpoint для диагностики
          let debugInfo = '';
          try {
            const dr = await fetch(API_BASE + '/api/debug_auth', { headers: hdrs() });
            const dd = await dr.json();
            debugInfo = '<br><b>Debug:</b> ' + JSON.stringify(dd, null, 0);
          } catch (_) {}
          content.innerHTML = '<p class="msg error">401 — Не авторизован.' + debugInfo + '</p>';
          return;
        }
        if (r.status === 403) { content.innerHTML = '<p class="msg error">Доступ запрещён. Только для администраторов.</p>'; return; }
        if (!r.ok) { content.innerHTML = '<p class="msg error">Ошибка: ' + r.status + '</p>'; return; }

        const data = await r.json();
        totalUsers = data.total;
        renderTable(data.users);
        renderPagination();
      } catch (e) {
        content.innerHTML = '<p class="msg error">Ошибка сети: ' + e.message + '</p>';
      }
    }

    function renderTable(users) {
      const content = document.getElementById('content');
      if (!users.length) { content.innerHTML = '<p>Пользователей не найдено.</p>'; return; }
      let html = '<table><thead><tr><th>ФИО</th><th>TG ID</th><th>Роль</th><th>Уровень</th><th>Подписка до</th><th></th></tr></thead><tbody>';
      for (const u of users) {
        const endDate = u.subscription_end_date || '';
        const roleLabel = u.role === 'assistant' ? 'ассистент' : 'врач';
        html += '<tr data-id="' + u.id + '">' +
          '<td>' + escapeHtml(u.full_name) + (u.phone ? '<br><span class="id">' + escapeHtml(u.phone) + '</span>' : '') + '</td>' +
          '<td class="id">' + u.telegram_id + '</td>' +
          '<td class="role">' + roleLabel + '</td>' +
          '<td><select class="tier" data-id="' + u.id + '">' +
          [0,1,2].map(t => '<option value="' + t + '"' + (u.subscription_tier === t ? ' selected' : '') + '>' + TIER_NAMES[t] + '</option>').join('') +
          '</select></td>' +
          '<td><input type="date" class="end-date" data-id="' + u.id + '" value="' + endDate + '"></td>' +
          '<td><button type="button" class="btn-save" data-id="' + u.id + '">Сохранить</button></td>' +
          '</tr>';
      }
      html += '</tbody></table>';
      content.innerHTML = html;
      content.querySelectorAll('.btn-save').forEach(btn => {
        btn.addEventListener('click', () => saveUser(parseInt(btn.dataset.id, 10)));
      });
    }

    function renderPagination() {
      const bar = document.getElementById('paginationBar');
      if (totalUsers <= PAGE_SIZE) { bar.innerHTML = ''; return; }
      const page = Math.floor(currentOffset / PAGE_SIZE) + 1;
      const pages = Math.ceil(totalUsers / PAGE_SIZE);
      bar.innerHTML =
        '<button class="secondary" ' + (page <= 1 ? 'disabled' : '') + ' id="pgPrev">&larr;</button>' +
        '<span>' + page + ' / ' + pages + ' (всего ' + totalUsers + ')</span>' +
        '<button class="secondary" ' + (page >= pages ? 'disabled' : '') + ' id="pgNext">&rarr;</button>';
      document.getElementById('pgPrev')?.addEventListener('click', () => { currentOffset = Math.max(0, currentOffset - PAGE_SIZE); loadUsers(); });
      document.getElementById('pgNext')?.addEventListener('click', () => { currentOffset += PAGE_SIZE; loadUsers(); });
    }

    async function saveUser(id) {
      const row = document.querySelector('tr[data-id="' + id + '"]');
      const tier = parseInt(row.querySelector('.tier').value, 10);
      const endDate = row.querySelector('.end-date').value.trim() || null;
      const btn = row.querySelector('.btn-save');
      btn.disabled = true;
      try {
        const r = await fetch(API_BASE + '/api/users/' + id, {
          method: 'PATCH', headers: hdrs(),
          body: JSON.stringify({ subscription_tier: tier, subscription_end_date: endDate }),
        });
        if (!r.ok) { const err = await r.json().catch(() => ({})); showMsg('Ошибка: ' + (err.detail || r.status), true); return; }
        showMsg('Сохранено');
        setTimeout(() => showMsg(''), 2000);
        loadStats();
      } catch (e) { showMsg('Ошибка сети: ' + e.message, true); }
      finally { btn.disabled = false; }
    }

    /* ── Events ── */
    document.getElementById('btnRefresh').addEventListener('click', () => { currentOffset = 0; loadUsers(); loadStats(); });
    document.getElementById('tierFilter').addEventListener('change', () => { currentOffset = 0; loadUsers(); });
    document.getElementById('searchInput').addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => { currentOffset = 0; loadUsers(); }, 350);
    });

    updateDebugInfo();
    if (Telegram) Telegram.onEvent('themeChanged', updateDebugInfo);
    loadStats();
    loadUsers();
  </script>
</body>
</html>
