<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MiniStom ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 12px;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
    }
    h1 { font-size: 1.25rem; margin: 0 0 12px 0; }
    .toolbar { margin-bottom: 12px; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border: 1px solid var(--tg-theme-hint-color, #999);
      padding: 8px;
      text-align: left;
    }
    th { background: var(--tg-theme-secondary-bg-color, #eee); }
    select, input[type=date] {
      padding: 6px;
      font-size: 13px;
      min-width: 100px;
    }
    button {
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #fff);
      border: none;
      border-radius: 6px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .msg { padding: 8px; margin: 8px 0; border-radius: 6px; }
    .msg.error { background: #fdd; color: #c00; }
    .msg.ok { background: #dfd; color: #060; }
    .loading { color: var(--tg-theme-hint-color); }
    .id { font-size: 12px; color: var(--tg-theme-hint-color); }
  </style>
</head>
<body>
  <h1>üõ† –ê–¥–º–∏–Ω–∫–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏</h1>
  <div id="msg"></div>
  <div class="toolbar">
    <button type="button" id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
  </div>
  <div id="content">
    <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
  </div>

  <script>
    const Telegram = window.Telegram?.WebApp;
    if (Telegram) {
      Telegram.ready();
      Telegram.expand();
    }

    const API_BASE = window.location.origin;
    function getInitData() {
      return Telegram?.initData || '';
    }

    function headers() {
      const init = getInitData();
      return {
        'Content-Type': 'application/json',
        'X-Telegram-Init-Data': init,
      };
    }

    function showMsg(text, isError = false) {
      const el = document.getElementById('msg');
      el.textContent = text;
      el.className = 'msg ' + (isError ? 'error' : 'ok');
      el.style.display = text ? 'block' : 'none';
    }

    const TIER_NAMES = { 0: 'Basic', 1: 'Standard', 2: 'Premium' };

    async function loadUsers() {
      const content = document.getElementById('content');
      content.innerHTML = '<p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>';
      var initData = getInitData();
      if (!initData || initData.length < 10) {
        content.innerHTML = '<p class="msg error">–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É —Ç–æ–ª—å–∫–æ –∏–∑ Telegram: –≤ –±–æ—Ç–µ –Ω–∞–ø–∏—à–∏—Ç–µ /admin –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ê–¥–º–∏–Ω–∫–∞ (Web App)¬ª. –í –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.</p>';
        return;
      }
      try {
        const r = await fetch(API_BASE + '/api/users', { headers: headers() });
        if (r.status === 401) {
          content.innerHTML = '<p class="msg error">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –í—ã –æ—Ç–∫—Ä—ã–ª–∏ –∏–∑ –±–æ—Ç–∞? –¢–æ–≥–¥–∞ –≤ Railway —É —Å–µ—Ä–≤–∏—Å–∞ –∞–¥–º–∏–Ω–∫–∏ (industrious-insight) –≤ Variables –∑–∞–¥–∞–π—Ç–µ BOT_TOKEN ‚Äî —Ç–æ—Ç –∂–µ, —á—Ç–æ —É —Å–µ—Ä–≤–∏—Å–∞ –±–æ—Ç–∞ (Mystom). –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ —Å–¥–µ–ª–∞–π—Ç–µ Redeploy.</p>';
          return;
        }
        if (r.status === 403) {
          content.innerHTML = '<p class="msg error">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.</p>';
          return;
        }
        if (!r.ok) {
          content.innerHTML = '<p class="msg error">–û—à–∏–±–∫–∞: ' + r.status + '</p>';
          return;
        }
        const users = await r.json();
        renderTable(users);
      } catch (e) {
        content.innerHTML = '<p class="msg error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message + '</p>';
      }
    }

    function renderTable(users) {
      const content = document.getElementById('content');
      if (!users.length) {
        content.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç.</p>';
        return;
      }
      let html = '<table><thead><tr><th>–§–ò–û</th><th>Telegram ID</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ</th><th></th></tr></thead><tbody>';
      for (const u of users) {
        const endDate = u.subscription_end_date || '';
        html += '<tr data-id="' + u.id + '">' +
          '<td>' + escapeHtml(u.full_name) + '</td>' +
          '<td class="id">' + u.telegram_id + '</td>' +
          '<td><select class="tier" data-id="' + u.id + '">' +
          [0,1,2].map(t => '<option value="' + t + '"' + (u.subscription_tier === t ? ' selected' : '') + '>' + TIER_NAMES[t] + '</option>').join('') +
          '</select></td>' +
          '<td><input type="date" class="end-date" data-id="' + u.id + '" value="' + endDate + '"></td>' +
          '<td><button type="button" class="btn-save" data-id="' + u.id + '">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></td>' +
          '</tr>';
      }
      html += '</tbody></table>';
      content.innerHTML = html;

      content.querySelectorAll('.btn-save').forEach(btn => {
        btn.addEventListener('click', () => saveUser(parseInt(btn.dataset.id, 10)));
      });
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    async function saveUser(id) {
      const row = document.querySelector('tr[data-id="' + id + '"]');
      const tierSelect = row.querySelector('.tier');
      const dateInput = row.querySelector('.end-date');
      const tier = parseInt(tierSelect.value, 10);
      const endDate = dateInput.value.trim() || null;

      const btn = row.querySelector('.btn-save');
      btn.disabled = true;
      try {
        const r = await fetch(API_BASE + '/api/users/' + id, {
          method: 'PATCH',
          headers: headers(),
          body: JSON.stringify({
            subscription_tier: tier,
            subscription_end_date: endDate,
          }),
        });
        if (!r.ok) {
          const err = await r.json().catch(() => ({}));
          showMsg('–û—à–∏–±–∫–∞: ' + (err.detail || r.status), true);
          return;
        }
        showMsg('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        setTimeout(() => showMsg(''), 2000);
      } catch (e) {
        showMsg('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message, true);
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById('btnRefresh').addEventListener('click', loadUsers);
    loadUsers();
  </script>
</body>
</html>
