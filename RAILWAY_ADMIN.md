# Railway: запуск веб-админки

## Вариант A: Без настройки Start Command в Railway

Оба сервиса (бот и админка) используют **один и тот же** образ и одну команду запуска. Режим задаётся **только переменной** `SERVICE_TYPE`.

### Один сервис (бот + админка вместе)

- Добавьте **один** сервис из репозитория (Dockerfile).
- **Start Command не трогайте** — по умолчанию запускаются миграции, веб-админка в фоне и бот.
- Variables: `BOT_TOKEN`, `ADMIN_IDS`, `DATABASE_URL`, при желании `ADMIN_WEBAPP_URL`.
- **Generate Domain** для этого сервиса — админка будет на том же URL (порт 8080). Скопируйте URL в `ADMIN_WEBAPP_URL` и сделайте Redeploy.

Никакой настройки Start Command, один сервис.

### Два сервиса (бот и админка отдельно)

- **Сервис бота:** Variables как обычно. Start Command **не меняйте** (по умолчанию `python -m app.start` — бот + админка в фоне). Либо задайте переменную `SERVICE_TYPE=bot` для ясности.
- **Сервис только админки:** добавьте второй сервис из того же репо. В **Variables** задайте `SERVICE_TYPE=web` и те же `BOT_TOKEN`, `ADMIN_IDS`, `DATABASE_URL`. **Start Command оставьте пустым** (будет использоваться команда из Dockerfile: `python -m app.start`).
- В сервисе бота в Variables укажите `ADMIN_WEBAPP_URL` = URL второго сервиса (Generate Domain для сервиса админки).

Итого: для веб-админки **ничего не настраивать в разделе Start Command** — только переменная `SERVICE_TYPE=web` и те же Variables, что у бота.

---

## Вариант B: Явный Start Command (как раньше)

Если по какой-то причине не используете `app.start`, для сервиса **только админки** можно задать вручную:

- **Start Command:** `python -m admin_webapp.run_web`  
  (не `uvicorn ... --port $PORT` — иначе ошибка `'$PORT' is not a valid integer`.)
- **Variables:** `BOT_TOKEN`, `ADMIN_IDS`, `DATABASE_URL` — те же значения, что у бота.

---

## Устранение неполадок

### 401 / «неверная подпись»

Подпись initData проверяется тем же токеном, с которым пользователь открыл Web App. У сервиса **веб-админки** переменная **`BOT_TOKEN`** должна **совпадать побайтово** с токеном сервиса бота.

- Откройте сервис **бота** → **Variables** → скопируйте значение **BOT_TOKEN** (Ctrl+C).
- Откройте сервис **админки** → **Variables** → вставьте в **BOT_TOKEN** (Ctrl+V), убедитесь, что нет пробела или переноса в начале/конце.
- Сохраните и сделайте **Redeploy** сервиса админки.
- Если используете общие (project-level) переменные, убедитесь, что у сервиса админки нет своего переопределения со старым значением. Лучше задать BOT_TOKEN явно в сервисе админки, скопировав из бота.

В логах админки при ошибке выводится `len=` и `repr=` токена после strip — по ним можно убедиться, что длина 46 и нет символов `\n`/`\r` в конце.

**Что смотреть в логах при 401:** откройте админку из бота, нажмите «Обновить список» и в **Deploy Logs** найдите строки: `[api_users] запрос с Host=...`, `[api_users] initData получен, len=...`, `validate_init_data: data_check_string len=..., keys=...` и при неудаче — `validate_init_data: неверная подпись...`. Если этих строк **нет** — запрос до сервера не доходит (проверьте в браузере вкладку «Сеть»: уходит ли запрос на ваш домен и с заголовком `X-Telegram-Init-Data`).

### Conflict: «only one bot instance is running»

Telegram не допускает два процесса с одним токеном, делающих getUpdates. Значит, бот запущен в двух местах.

- **Два сервиса:** у сервиса **только админки** обязательно задайте **`SERVICE_TYPE=web`** и **не задавайте** свой Start Command. Иначе из образа запустится `app.start` без web → поднимутся и бот, и админка → второй экземпляр бота и Conflict.
- **Один сервис бота:** в **Settings** сервиса бота проверьте **Replicas** — лучше 1. При нескольких репликах каждая будет держать своего бота → Conflict.
- **При деплое** на несколько секунд работают старый и новый контейнер → Conflict и SIGTERM у старого — это нормально. После остановки старого реплики в логах появится «Connection established».
- После смены Variables или Start Command дождитесь полной остановки старых контейнеров и нового деплоя, прежде чем снова открывать бота.

### ServerDisconnectedError в логах

Сообщения вида `TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected` и затем «Connection established» означают обрыв long-polling соединения с Telegram (таймауты, сеть). Бот сам переподключается. На работу это обычно не влияет; при частых обрывах можно проверить стабильность сети/региона деплоя.

### Сервис админки падает с «'$PORT' is not a valid integer»

В Railway переменная `$PORT` в Custom Start Command может не подставляться. **Не используйте** команду вида `uvicorn ... --port $PORT`. Либо оставьте Start Command пустым и задайте **`SERVICE_TYPE=web`**, либо укажите порт явно (скрипт сам читает PORT из окружения).

---

Подробнее: [SETUP.md](SETUP.md) → «Вариант 2: Railway» и «Устранение неполадок».
